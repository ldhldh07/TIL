## 커넥션과 세그먼트

### 커넥션

3계층까지는 컴퓨터 간의 데이터를 송수신할 수 있었음

TCP에서는 애플리케이션 간의 데이터 송수신을 함   

이 애플리케이션 간의 송수신을 하는 데이터의 길을 커넥션이라고 한다

3계층의 라우팅에서 나온 경로와는 다른 의미로 TCP에서 만들어진 통신로는가상적인 통신로

- 사전에 전용 통신로를 확보해 둠으로써 확실하게 데이터를 보낸다

컴퓨터까지 데이터가 도달한다는 것과 데이터를 확실하게 주고받는 것은 별개의 문제

- 상대가 존재하지 않을 수도 있음
- 상대는 존재하지만 수신할 준비가 안되어 있을지도 모름

- 수신은 가능한데 바빠서 데이터를 처리 못할 수도 있음

데이터 전송을 시작하기 전에 미리 확인을 주고받아 둠

- 상대에게 확실하게 전달한 것을 확인

커넥션 확립

- 실제의 통신로가 아닌 송신측과 수신측 사이에 가상의 통신로가 생긴다고 여기는 것
- 케이블이 어떻게 연결되고 어느 라우터를 통해 수신처까지 도달한 것인지는 상관 없다 

#### TCP 헤더

크기는 기본적으로  20옥텟

6비트의 제어비트(플래그)는 그 TCP의 데이터의 의미

포트 번호, 시퀀스 번호, 플래그 등 약 20 옥텟

송신처 포트 번호 (16비트) 수신처 포트 번호 16비트

시퀀스 번호 (3비트)

확인 응답 번호 32비트

데이터 오프셋 4비트

예약(6비트)

플래그(6비트)

- URG
- ACJ
- PSH
- RST
- SYN
- FIN

윈도우 16비트

긴급포인터 16비트

### 커넥션의 확립

커넥션을 확립하기 위해서는 상대가 데이터 전송을 허가해주지 않으면 안된다

- 확실한 데이터 전송을 하는 통신로를 확보하기 위해 상대에게 데이터 전송의 허가 요청을 보냄
- 상대는 그것에 대한 허가를 송신처에게 알림
  - 이것으로 데이터가 상대에게 바르게 전달된 것을 확인할 수 있음
  - 통신로가 확보
- 수신처 측이 송신처에게 데이터 전송 허가 요청을 보냄
- 송신처도 데이터 전송 허기를 보냄
  - 쌍방향의 통로가 확보

이 커넥션의 확립에서는 지금 설명한 것처럼 3번 주고받아야 하기 때문에 3방향의 악수, 쓰리웨이 핸드쉐이크라고 부름

쓰리웨이 핸드쉐이크

- 커넥션 확립요청
  - TCP 헤더의 SYN의 비트가 1로 정해져 있다
- 커넥션 확립응답 + 확립요청
  - TCP 헤더의 SYN과 ACK의 비트가 1로 정해져 있다
- 커넥션 확립응답
  - ACK
- 쌍방이 ESTABLISHED되면 커넥션 확립

커넥션 단절

FIN+ACK

ACK

FIN + ACK

ACK

### 세그먼트 분할

TCP는 애플리케이션으로부터 받은 데이터(메시지)를 세그먼트로 캡슐화한다

MSS

- 캡슐화할 때, 한 개의 데이터를 MSS(Max Segment Size)로 분할

- 한개의 데이터가 복수의 세그먼트가 됨

시퀀스 번호

- 각각의 세그먼트에 번호를 부여
- TCP 헤더에 항목이 있다
- 세그먼트에 포함되어 있는 데이터의 선두 옥텟에 붙여진 번호

MSS 사이즈로 데이터를 분할해 그 선두 번호를 시퀀스 번호라고 한다.

통신할 데이터에 임의의 번호(이 그림에서는 1번) 부터 순서대로 1옥텟(8비트)마다 번호를 할당한다

- 송신할 데이터에 맨 앞부분부터 번호를 붙인다
- 송신할 세그먼트의 선두 번호를 시퀀스 번호로 삼는다

## 윈도우 제어

### 에러 복구

TCP에서는 시퀀스 번호를 사용해서 에러를 복구한다

확인 응답

- 세그먼트를 수신하면 수신한 것을 송신처에 전달
- 보내는 측의 데이터 받아줘에 대해 받았어라고 답장하는 것

데이터 송신 시에는 시퀀스 번호가, 확인응답에는 확인응답 번호가 중요한 값이 됨

시퀀스 번호

- 보내는 데이터의 앞 부분에 있는 옥텟 1번호

확인응답 번호는 다음에 받고 싶은 데이터의 선두 옥텟 번호

시퀀스 번호로 세그먼트가 보내느 ㄴ데이터가 전체의 어느 부분에 해당하는지를 알 수 있다

확인응답 번호로 다음에 받고 싶은 데이터 번호를 알림

- 수신측이 어느 데이터까지 받았는지 알 수 있음

어느 데이터까지 받았는지 전달하는 것은 흐름제어에서도 중요하다

- 에러가 발생해서 데이터가 상대방에게 도달하지 않았거나 확인응답이 도달하지 않았을 때는 재전송을 함

RTT(Round Trip Time)

- 지금까지 보낸 데이터에 대해 확인응답이 돌아오기까지 걸린 시간

- 초기값을 약3초로 정해 두고 그 후에 확인응답이 돌아오는데 걸린 시간을 동적으로 변경
  - 3초는 회선의 속도에 따라바뀜

### 윈도우 제어

세그먼트송신-> 확인응답이라는 흐름이 시간만 너무 걸림

복수의 세그먼트 전송-> 확인응답이라는 형태로 바꿈

- 시간 효율이 좋아짐
- 정확, 확실의 의미가 이상해짐

연속해서 세그먼트를 보냄으로써 효율 좋은 전송을 수행한다

- 세그먼트 3개
  - 한 개의 세그먼트에 대해 확인응답을 받기까지 다음 세그먼트를 보내지 않는다
- 세그먼트 6개
  - 어떤 일정 수의 세그먼트를 연속해서 보내어 확인응답을 받는다

#### 윈도우 제어

정확확실하고 효율적으로 보내기 위해 TCP는 흐름제어의 하나인 윈도ㅓ우 제어를 함

윈도우 제어에서는 일단 수신한 데이터를 일시적으로 보관해 두기 위한 버퍼(Buffer)가 있다

- 버퍼는 일시적으로 수신한 데이터를 보관해 두는 장소

#### 오버플로

데이터가 넘치는 것

#### 윈도우 사이즈

데이터가 손실되는 오버플로를 막기 위해 상대방에게 자신이 어느 정도 버퍼량을 가지고 있는지를 알려줄 필요가 있음

확인응답을 기다리지 않고 보낼 수 있는 데이터 양

버퍼를 넘치지 않도록 하기 위해 상대방의 버퍼량을 확인하면서 보냄

- 확실하게 수신할 수 있는 용량의 데이터만 송수신

## 포트 번호

### 애플리케이션 간 통신

포트 번호

- PC에서 브라우저 소프트웨어, 메일 소프트웨어 등 통신하는 애플리케이션을 여러 개 사용하는 경우, 어느 애플리케이션 용도의 데이터인지를 식별하지 않으면 안된다
- 각각의 데이터가 어느 애플리케이션으로부터 송신되었는지 · 어느 애플리케이션 수신인지를 결정

TCP 헤더에 송신처 포트 번호, 수신처 포트 번호라는 항목이 있다

각 컴퓨터 내부에는 통신 데이터를 흐르게 하기 위한 가상의 출입구가 있다

각 애플리케이션은 그 중에 하나를 선택해서 데이터 송수신의 입구를 삼음

애플리케이션과 TCP/IP 통신기능을 연결하는 길

포트

- 16비트, 즉 65,536개가 있음
- 각각 0부터 번호가 매겨져 있음

통신중인 애플리케이션은 각각 이 포트 번호와 접속하고 있음

이 포트에 붙어진 포트 번호로 데이터를 보낼 애플리케이션을 특정

IP 번호와는 달리 애플리케이션마다 번호가 있고 그것이 포트 번호

실제로 송수신

- IP번호와 포트번호를 사용해서 어느 컴퓨터의 어느 애플리케이션인지 식별
- IP번호와 포트 번호는 한 세트

수신처 포트 번호를 모르면 데이터를 보낼 수 없다

- 수신받을 애플리케이션이 포트와 접속해 있지 않으면 데이터는 도달할 수 없다

자주 사용하는 서버 애플리케이션(Server Application)은 사전에 정해진 번호를 사용함으로써 서비스를 제공할 수 있도록 함

- 데이터를 보내고 싶은 애플리케이션의 포트 번호는 알 수 없다

서버 애플리케이션

- 무언가 서비스를 제공하는 애플리케이션
- 홈페이지를 공개하거나 파일을 가지고 있어서 파일전송을 하거나 메일전송을 함

웰 노운 포트(Well Known Port)

- 65,536개의 포트 번호 중 1~1023번이 여기에 해당
- 서비스를 제공하고 싶은 서버는 이들 번호를 애플리케이션에 할당
- 송신처는 이 정해진 포트에 데이터를 보냄
- 예)
  - 웹페이지를 보고 싶으면 80번 포트에 보내면 됨

수신처의 포트 번호가 다르기 때문에 복수의 데이터를 수신해도, 데이터를 보낼 애플리케이션을 명확하게 구별할 수 있다

| 포트 번호 | 애플리케이션    |
| --------- | --------------- |
| 20        | FTP 데이터      |
| 21        | FTP 컨트롤      |
| 23        | TELNET          |
| 25        | SMTP            |
| 53        | DNS             |
| 67        | DHCP 서버       |
| 68        | DHCP 클라이언트 |
| 69        | TFTP            |
| 80        | HTTP            |
| 110       | POP3            |
| 161       | SNMP 요청       |
| 162       | SNMP 트랩       |
| 443       | HTTPS           |
| 520       | RIP             |

송신처의 포트 번호

- 1023번 이하는 웰 노운 포트 번호이기 때문에 사용해서는 안됨

- 1024~49151번까지는 등록된 포트라고 부르는데 미리 등록되어 있는 포트 번호를 말함

  - 이미 정해진 애플리케이션과 연결되어 있음

- 이런 번호 이외의 49152~65535번까지의 번호 중에서 원하는 번호를 선택

- 다른 애플리케이션이 사용하고 있는 번호를 사용해서는 안된다

- 분류는 어디까지나 권고라 강제성은 없음

  - 현재 애플리케이션이 사용하고 있는 번호를 전달할 방법이 없기 때문에 사전에 정한 번호를 사용하지 않으면 요청하는 측이 곤란
  - 그래서 네트워크와는 별개의 방법, 말로 전하든지 메일로 전하는 수밖에 없음

  